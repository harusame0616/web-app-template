# 技術仕様

## 1. 技術スタック

### 1.1 フロントエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js | 15.x | フレームワーク（App Router） |
| React | 19.x | UIライブラリ |
| TypeScript | 5.x | 型安全な開発 |
| Tailwind CSS | 3.x | スタイリング |
| shadcn/ui | latest | UIコンポーネント |

### 1.2 バックエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js Server Actions | 15.x | API実装 |
| Prisma | 6.x | ORM |
| PostgreSQL | 15.x | データベース |
| Supabase | latest | 認証・ストレージ |

### 1.3 バリデーション・フォーム
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Valibot | 1.x | スキーマバリデーション |
| React Hook Form | 7.x | フォーム管理 |
| @hookform/resolvers | 3.x | Valibot連携 |

### 1.4 その他ライブラリ
| 技術 | 用途 |
|------|------|
| bcryptjs | パスワードハッシュ化 |
| date-fns | 日時フォーマット |
| lucide-react | アイコン |
| sonner | Toast通知 |

## 2. ディレクトリ構造

```
apps/web/src/
├── app/
│   └── member/
│       └── board/
│           ├── page.tsx                    # スレッド一覧
│           ├── new/
│           │   └── page.tsx               # スレッド作成
│           └── [threadId]/
│               ├── page.tsx                # スレッド詳細
│               └── edit/
│                   └── page.tsx            # スレッド編集
├── features/
│   └── board/
│       ├── thread/
│       │   ├── list/
│       │   │   ├── data.ts               # データ取得関数
│       │   │   ├── thread-list-container.tsx
│       │   │   ├── thread-list-presenter.tsx
│       │   │   └── thread-card.tsx
│       │   ├── create/
│       │   │   ├── actions.ts            # Server Actions
│       │   │   ├── create-thread-form.tsx
│       │   │   ├── create-thread.ts      # ビジネスロジック
│       │   │   └── schema.ts             # バリデーション
│       │   ├── detail/
│       │   │   ├── data.ts
│       │   │   ├── thread-detail-container.tsx
│       │   │   └── thread-detail-presenter.tsx
│       │   ├── edit/
│       │   │   ├── actions.ts
│       │   │   ├── edit-thread-form.tsx
│       │   │   ├── edit-thread.ts
│       │   │   └── schema.ts
│       │   └── delete/
│       │       ├── actions.ts
│       │       └── delete-thread.ts
│       ├── comment/
│       │   ├── create/
│       │   │   ├── actions.ts
│       │   │   ├── create-comment-form.tsx
│       │   │   ├── create-comment.ts
│       │   │   └── schema.ts
│       │   ├── edit/
│       │   │   ├── actions.ts
│       │   │   ├── edit-comment-modal.tsx
│       │   │   ├── edit-comment.ts
│       │   │   └── schema.ts
│       │   ├── delete/
│       │   │   ├── actions.ts
│       │   │   └── delete-comment.ts
│       │   └── list/
│       │       ├── comment-list.tsx
│       │       └── comment-item.tsx
│       ├── media/
│       │   ├── upload-image.ts
│       │   ├── upload-video.ts
│       │   ├── media-viewer.tsx
│       │   └── video-player.tsx
│       └── common/
│           ├── password-modal.tsx
│           ├── board-types.ts
│           └── board-constants.ts
└── lib/
    ├── supabase/
    │   ├── storage.ts
    │   └── cloudflare-stream.ts
    └── board/
        └── board-utils.ts
```

## 3. 命名規則

### 3.1 ファイル名
- **コンポーネント**: kebab-case（例: thread-list-container.tsx）
- **Server Actions**: actions.ts（固定）
- **ビジネスロジック**: kebab-case.ts（例: create-thread.ts）
- **型定義**: kebab-case-types.ts（例: board-types.ts）
- **定数**: kebab-case-constants.ts（例: board-constants.ts）

### 3.2 変数・関数名
- **変数**: camelCase（例: threadTitle）
- **定数**: UPPER_SNAKE_CASE（例: MAX_IMAGE_SIZE）
- **関数**: camelCase（例: createThread）
- **Server Actions**: camelCase + Action（例: createThreadAction）
- **カスタムフック**: use + PascalCase（例: useCreateThread）

### 3.3 型名
- **型**: PascalCase（例: Thread, Comment）
- **Props型**: ComponentName + Props（例: ThreadListProps）
- **入力型**: Action + Input（例: CreateThreadInput）
- **出力型**: Action + Response（例: ThreadListResponse）

## 4. コーディング規約

### 4.1 TypeScript
```typescript
// 型定義はtypeを使用
type Thread = {
  id: string;
  title: string;
  // ...
};

// 関数の戻り値は明示
function calculateTotal(items: Item[]): number {
  return items.reduce((sum, item) => sum + item.price, 0);
}

// Enumは使わず、const objectを使用
export const ThreadStatus = {
  ACTIVE: 'active',
  DELETED: 'deleted',
} as const;

type ThreadStatus = typeof ThreadStatus[keyof typeof ThreadStatus];
```

### 4.2 React Component
```typescript
// RSC（React Server Component）
export async function ThreadListContainer({ page }: Props) {
  const data = await getThreadList(page);
  return <ThreadListPresenter threads={data.threads} />;
}

// Client Component
'use client';

export function ThreadListPresenter({ threads }: Props) {
  return (
    <div>
      {threads.map((thread) => (
        <ThreadCard key={thread.id} thread={thread} />
      ))}
    </div>
  );
}
```

### 4.3 Server Actions
```typescript
'use server';

import { Result } from '@/lib/result';

export async function createThreadAction(
  input: CreateThreadInput
): Promise<Result<Thread>> {
  try {
    // バリデーション
    const validated = v.parse(CreateThreadSchema, input);
    
    // ビジネスロジック呼び出し
    const thread = await createThread(validated);
    
    // 成功レスポンス
    return { success: true, data: thread };
  } catch (error) {
    // エラーレスポンス
    return { 
      success: false, 
      error: 'スレッドの作成に失敗しました' 
    };
  }
}
```

### 4.4 コメント規約
```typescript
// コメントは「なぜ」を説明する
// ❌ 悪い例：スレッドを作成する
// ⭕ 良い例：同時投稿による重複を防ぐためトランザクション内で処理
await prisma.$transaction(async (tx) => {
  // ...
});
```

## 5. エラーハンドリング

### 5.1 Result型パターン
```typescript
// lib/result.ts
export type Result<T> = 
  | { success: true; data: T }
  | { success: false; error: string };

// 使用例
const result = await createThreadAction(input);
if (!result.success) {
  toast.error(result.error);
  return;
}
// result.data が型安全に使える
```

### 5.2 エラーの種類
| エラー種別 | 処理方法 | ユーザー表示 |
|-----------|---------|-------------|
| バリデーションエラー | フォームフィールドに表示 | 具体的なエラー内容 |
| 認証エラー | モーダル再表示 | パスワードが違います |
| システムエラー | Toast通知 | エラーが発生しました |
| ネットワークエラー | リトライボタン表示 | 通信エラーが発生しました |

## 6. パフォーマンス最適化

### 6.1 Server Components活用
- データ取得はServer Componentで実行
- クライアントへの送信データ量を削減
- Suspenseで段階的レンダリング

### 6.2 画像最適化
```typescript
import Image from 'next/image';

// Next.js Imageコンポーネント使用
<Image
  src={imageUrl}
  alt={alt}
  width={800}
  height={600}
  loading="lazy"
  placeholder="blur"
/>
```

### 6.3 コード分割
```typescript
// 重いコンポーネントの動的インポート
const MediaViewer = dynamic(
  () => import('./media-viewer'),
  { 
    loading: () => <Skeleton />,
    ssr: false 
  }
);
```

## 7. テスト戦略

### 7.1 ユニットテスト（Vitest）
```typescript
// create-thread.test.ts
describe('createThread', () => {
  it('正常にスレッドを作成できる', async () => {
    const input = {
      title: 'テストタイトル',
      authorName: 'テスト太郎',
      content: 'テスト本文',
    };
    
    const result = await createThread(input);
    
    expect(result).toMatchObject({
      title: 'テストタイトル',
      authorName: 'テスト太郎',
    });
  });
});
```

### 7.2 E2Eテスト（Playwright）
```typescript
// thread.e2e.test.ts
test('スレッド作成フロー', async ({ page }) => {
  await page.goto('/member/board/new');
  
  await page.fill('[name="title"]', 'E2Eテストスレッド');
  await page.fill('[name="authorName"]', 'E2E太郎');
  await page.fill('[name="content"]', 'E2Eテスト本文');
  
  await page.click('button[type="submit"]');
  
  await expect(page).toHaveURL('/member/board');
  await expect(page.locator('text=E2Eテストスレッド')).toBeVisible();
});
```

## 8. 環境変数

```env
# .env.local
DATABASE_URL=postgresql://...
DIRECT_URL=postgresql://...
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
CLOUDFLARE_ACCOUNT_ID=...
CLOUDFLARE_STREAM_API_TOKEN=...
```

## 9. ビルド・デプロイ

### 9.1 開発環境
```bash
# 開発サーバー起動
pnpm dev

# データベースマイグレーション
pnpm prisma migrate dev

# 型生成
pnpm prisma generate
```

### 9.2 本番ビルド
```bash
# ビルド
pnpm build

# 型チェック
pnpm type:check

# Lint
pnpm lint:check

# テスト
pnpm test
pnpm test:e2e
```

### 9.3 デプロイフロー
1. GitHub Actionsでテスト実行
2. Vercelへ自動デプロイ
3. Supabase Migrationsで本番DB更新

## 10. 監視・ログ

### 10.1 エラー監視
- Vercel Analytics
- カスタムエラーログ

### 10.2 パフォーマンス監視
- Core Web Vitals
- Server Action実行時間

### 10.3 ログ出力
```typescript
// 開発環境のみログ出力
if (process.env.NODE_ENV === 'development') {
  console.log('[Board]', 'Thread created:', thread.id);
}
```